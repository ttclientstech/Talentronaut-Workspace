name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  DEPLOY_PATH: /var/www/work-manager

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: TypeScript type check
        run: pnpm build
        env:
          # Dummy env vars for build (using proper format to pass validation)
          MONGODB_URI: mongodb://localhost:27017/test
          JWT_SECRET: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
          GEMINI_API_KEY: AIzaSyABCDEF123456789_test_key_for_build_only
          NODE_ENV: production

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          envs: MONGODB_URI,JWT_SECRET,GEMINI_API_KEY,NODE_ENV,NEXT_PUBLIC_API_URL,DOMAIN_NAME,SSL_EMAIL,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION
          script: |
            set -e

            echo "ÔøΩ Starting deployment..."

            # --- Provisioning Section ---
            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
                echo "üì¶ Node.js not found. Installing..."
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt-get install -y nodejs
            fi

            # Install pnpm if not present
            if ! command -v pnpm &> /dev/null; then
                echo "üì¶ pnpm not found. Installing..."
                sudo npm install -g pnpm
            fi

            # Install PM2 if not present
            if ! command -v pm2 &> /dev/null; then
                echo "üì¶ PM2 not found. Installing..."
                sudo npm install -g pm2
            fi

            # --- Nginx Configuration ---
            # Install Nginx if not present
            if ! command -v nginx &> /dev/null; then
                echo "üì¶ Nginx not found. Installing..."
                sudo apt-get update
                sudo apt-get install -y nginx
            fi

            # Configure Nginx Proxy
            echo "üîß Configuring Nginx..."
            cat << 'NGINX_CONF' | sudo tee /etc/nginx/sites-available/default > /dev/null
            # Catch-all block to drop requests to IP or unmatched domains
            server {
                listen 80 default_server;
                server_name _;
                return 444; # Connection closed without response
            }

            # Main site block
            server {
                listen 80;
                server_name ${{ secrets.DOMAIN_NAME }};

                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                }
            }
            NGINX_CONF

            # Test and Reload Nginx
            sudo nginx -t && sudo systemctl reload nginx

            # --- SSL Configuration (Certbot) ---
            # Install Certbot if not present
            if ! command -v certbot &> /dev/null; then
                echo "üì¶ Certbot not found. Installing..."
                sudo apt-get install -y certbot python3-certbot-nginx
            fi

            # Generate/Install SSL Certificate
            echo "üîí Configuring SSL for ${{ env.DOMAIN_NAME }}..."
            # Only run if domain is set
            if [ -n "${{ env.DOMAIN_NAME }}" ]; then
                 sudo certbot --nginx -d "${{ env.DOMAIN_NAME }}" --non-interactive --agree-tos -m "${{ env.SSL_EMAIL }}" --redirect --keep-until-expiring || echo "‚ö†Ô∏è SSL Certbot failed, but continuing..."
            fi
            # ---------------------------

            # Create log directory for PM2
            echo "üìù Configuring log directory..."
            if [ ! -d "/var/log/work-manager" ]; then
                sudo mkdir -p "/var/log/work-manager"
            fi
            sudo chown -R $USER:$USER "/var/log/work-manager"

            # Create deployment directory if it doesn't exist
            if [ ! -d "${{ env.DEPLOY_PATH }}" ]; then
              echo "üìÇ Directory not found. Creating ${{ env.DEPLOY_PATH }}..."
              sudo mkdir -p "${{ env.DEPLOY_PATH }}"
              sudo chown -R $USER:$USER "${{ env.DEPLOY_PATH }}"

              echo "üì• Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git "${{ env.DEPLOY_PATH }}"
            fi

            # Navigate to deployment directory
            cd ${{ env.DEPLOY_PATH }}

            # Pull latest changes
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Install dependencies
            echo "üì¶ Installing dependencies..."
            pnpm install --no-frozen-lockfile

            # Update environment variables
            echo "üîê Updating environment variables..."
            cat > .env.local << EOF
            MONGODB_URI=${MONGODB_URI}
            JWT_SECRET=${JWT_SECRET}
            GEMINI_API_KEY=${GEMINI_API_KEY}
            NODE_ENV=${NODE_ENV}
            NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
            AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            AWS_REGION=${AWS_REGION}
            EOF

            # Build application
            echo "üèóÔ∏è  Building application..."
            pnpm build

            # Restart PM2 process
            echo "‚ôªÔ∏è  Restarting application..."
            pm2 reload ecosystem.config.js --update-env

            # Save PM2 configuration
            pm2 save

            # Health check
            echo "üè• Running health check..."
            sleep 5

            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Deployment successful!"
            else
              echo "‚ùå Health check failed!"
              exit 1
            fi

            echo "üéâ Deployment completed at $(date)"

      - name: Notify deployment status
        if: false  # Disabled - optional Slack notifications (set to 'always()' and configure SLACK_WEBHOOK secret to enable)
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Deployment to EC2 ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Rollback deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e

            echo "‚ö†Ô∏è  Deployment failed, rolling back..."

            cd ${{ env.DEPLOY_PATH }}

            # Reset to previous commit
            git reset --hard HEAD~1

            # Reinstall dependencies (including devDependencies needed for build)
            pnpm install --no-frozen-lockfile

            # Rebuild
            pnpm build

            # Restart PM2
            pm2 reload ecosystem.config.js

            echo "‚úÖ Rolled back to previous version"
